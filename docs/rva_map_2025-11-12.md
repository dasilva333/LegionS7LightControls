# RVA Map — 2025-11-12

Image base and segments (from Ghidra):
- Image base: 0x180000000
- Segments: .text 0x180001000–0x18005ebff, .rdata 0x18005f000–0x18007abff, .data 0x18007b000–0x18007ec47

Global hardware object:
- Symbol: DAT_18007e840 (aka `hw`)
- Address: 0x18007e840 (RVA 0x7e840)
- Known result offsets: +0x154 (profile index), +0x158 (brightness)
- Profile info memory (when persisted): +0x1A8 (profileId), +0x1B0 (vector of 0x50-byte layer entries)

Triplets — Get operations (verified):
- Get-LightingProfileIndex
  - Function: FUN_180011210 @ 0x1800011210 (RVA 0x11210)
  - Pattern: locks → interface call → writes `*(uint*)(hw + 0x154)`
  - Xrefs/logs: 0x180062210, 0x1800622e0

- Get-BrightnessLevel
  - Function: FUN_180014110 @ 0x1800014110 (RVA 0x14110)
  - Pattern: locks → interface call → writes `*(uint*)(hw + 0x158)`
  - Xrefs/logs: 0x180063198, 0x180063280

Profile Info path (read/build):
- High-level init_profile_detail
  - Function: FUN_180014630 @ 0x1800014630 (RVA 0x14630)
  - Notes: orchestrates detail fetch; may not persist to (hw+0x1B0) on some builds

- Low-level GetProfileDetails
  - Function: FUN_180012660 @ 0x1800012660 (RVA 0x12660)
  - Notes: parses and fills 0x50-byte layer entries; large routine

- JSON builder (final emission)
  - Function: FUN_180054210 @ 0x1800054210 (RVA 0x54210)
  - Reads keys: `profileId` @ 0x18005fba0, `layers` @ 0x18005fbac
  - Helper: FUN_180052800 @ 0x1800052800 (RVA 0x52800)
  - Emits consistent JSON irrespective of memory persistence
  - Layer builder: FUN_180053e50 @ 0x1800053e50 (RVA 0x53e50)
  - Keys builder: FUN_18004f0b0 @ 0x180004f0b0 (RVA 0x4f0b0)
  - Confirmed bridge flow: after `init_profile_detail`, call `BuildPrep` (0x180054210) then `JsonWrite` (0x180015ea0); output is stored in the vendor std::string and mirrored to `%LOCALAPPDATA%\ProfileBridge\last.json` so the exact emitted JSON can be inspected.

Set operations (adjacent and useful):
- Set-LightingProfileIndex
  - Function: FUN_180013650 @ 0x1800013650 (RVA 0x13650)
  - Behavior: updates `*(uint*)(hw + 0x154)`; refreshes details via FUN_180012660; returns JSON via FUN_180054210

- Set-BrightnessLevel
  - Function: FUN_180014290 @ 0x1800014290 (RVA 0x14290)
  - Behavior: updates `*(uint*)(hw + 0x158)` and logs success/failure

- Set-LightingProfileDetails
  - Writer: FUN_180011380 @ 0x1800011380 (RVA 0x11380)
  - JSON parsers: AnimationConfig parser FUN_180051fa0 @ 0x1800051fa0; additional layer/key parsers nearby (documented in `docs/profile_details_parsing.md`)

- Set-ScreenToKeyboard (start screen color sync)
  - Function: FUN_180013eb0 @ 0x1800013eb0 (RVA 0x13eb0)
  - Spawns SyncKbdColorThread; sets flags at hw+0x150/0x160; dispatcher logs Success/Failed

- SyncKbdColorThread
  - Function: FUN_180010850 @ 0x1800010850 (RVA 0x10850)
  - Loops until hw+0x150 set; gated by hw+0x160

Dispatcher and command inventory:
- Command string vector builder
  - Function: FUN_18003df30 @ 0x180003df30 (RVA 0x3df30)
  - Enumerates keywords: Get/Set-* including Brightness, ProfileIndex, ProfileInfo, Capability, FirmwareVersion, etc.

- Request dispatcher
  - Function: FUN_18003b670 @ 0x180003b670 (RVA 0x3b670)
  - Notes: calls FUN_18003df30 (xref); decompilation was slow, but location confirmed via xref

- Get-KbdBasicInfo handler
  - Function: FUN_18003e840 @ 0x180003e840 (RVA 0x3e840)
  - Calls GetSupportedAnimation and keyboard info collector; returns JSON or failure string

JSON keys (selected) in builders:
- `profileId` 0x18005fba0, `layers` 0x18005fbac, `animationId` 0x180065ca0

Notes and recommendations:
- For stable reads, prefer calling FUN_180054210 to build profile JSON if (hw+0x1B0) is empty after init/parse.
- Triplets for Brightness/ProfileIndex are robust and write to (hw+0x158)/(hw+0x154) respectively.
- Additional fields touched during init: (hw+0x1f8) screen-sync flag, (hw+0x220) current animation id (observed in FUN_180014630).
- Reset profile
  - Function: FUN_1800138c0 @ 0x18000138c0 (RVA 0x138c0)
  - Behavior: resets profile; may reparse and rebuild JSON; reads ScreenLightingNumber from registry.
